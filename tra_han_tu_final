add_shortcode('cong_cu_tra_han_tu', 'render_tool_tra_han_tu_final');

function render_tool_tra_han_tu_final() {
    ob_start();
    
    // 1. D·ªÆ LI·ªÜU B·ªò TH·ª¶ (C·∫•u tr√∫c: "Ch·ªØ_G·ªëc (Ch·ªØ_Gi·∫£n_Th·ªÉ) - T√™n")
    // Nh·ªØng b·ªô kh√¥ng c√≥ gi·∫£n th·ªÉ th√¨ ch·ªâ ghi "Ch·ªØ_G·ªëc - T√™n"
    $radicals = [
        1 => "‰∏Ä - Nh·∫•t", 2 => "‰∏® - C·ªïn", 3 => "‰∏∂ - Ch·ªß", 4 => "‰∏ø - Phi·ªát", 5 => "‰πô - ·∫§t", 6 => "‰∫Ö - Quy·∫øt",
        7 => "‰∫å - Nh·ªã", 8 => "‰∫† - ƒê·∫ßu", 9 => "‰∫∫ - Nh√¢n", 10 => "ÂÑø - Nhi", 11 => "ÂÖ• - Nh·∫≠p", 12 => "ÂÖ´ - B√°t", 
        13 => "ÂÜÇ - Quynh", 14 => "ÂÜñ - M·ªãch", 15 => "ÂÜ´ - BƒÉng", 16 => "Âá† - K·ª∑", 17 => "Âáµ - Kh·∫£m", 18 => "ÂàÄ - ƒêao", 
        19 => "Âäõ - L·ª±c", 20 => "Âãπ - Bao", 21 => "Âåï - Ch·ªßy", 22 => "Âåö - Ph∆∞∆°ng", 23 => "Âå∏ - H·ªÖ", 24 => "ÂçÅ - Th·∫≠p", 
        25 => "Âçú - B·ªëc", 26 => "Âç© - Ti·∫øt", 27 => "ÂéÇ - H√°n", 28 => "Âé∂ - Kh∆∞", 29 => "Âèà - H·ª±u", 30 => "Âè£ - Kh·∫©u", 
        31 => "Âõó - Vi", 32 => "Âúü - Th·ªï", 33 => "Â£´ - Sƒ©", 34 => "Â§Ç - Tuy", 35 => "Â§ä - Tuy", 36 => "Â§ï - T·ªãch", 
        37 => "Â§ß - ƒê·∫°i", 38 => "Â•≥ - N·ªØ", 39 => "Â≠ê - T·ª≠", 40 => "ÂÆÄ - Mi√™n", 41 => "ÂØ∏ - Th·ªën", 42 => "Â∞è - Ti·ªÉu", 
        43 => "Â∞¢ - U√¥ng", 44 => "Â∞∏ - Thi", 45 => "Â±Æ - Tri·ªát", 46 => "Â±± - S∆°n", 47 => "Â∑õ - Xuy√™n", 48 => "Â∑• - C√¥ng", 
        49 => "Â∑± - K·ª∑", 50 => "Â∑æ - C√¢n", 51 => "Âπ≤ - Can", 52 => "Âπ∫ - Y√™u", 53 => "Âπø - Nghi·ªÖm", 54 => "Âª¥ - D·∫´n", 
        55 => "Âªæ - C·ªßng", 56 => "Âºã - D·∫∑c", 57 => "Âºì - Cung", 58 => "ÂΩê - K√Ω", 59 => "ÂΩ° - Sam", 60 => "ÂΩ≥ - X√≠ch",
        61 => "ÂøÉ - T√¢m", 62 => "Êàà - Qua", 63 => "Êà∑ - H·ªô", 64 => "Êâã - Th·ªß", 65 => "ÊîØ - Chi", 66 => "Êî¥ - Ph·ªôc", 
        67 => "Êñá - VƒÉn", 68 => "Êñó - ƒê·∫©u", 69 => "Êñ§ - C√¢n", 70 => "Êñπ - Ph∆∞∆°ng", 71 => "Êó† - V√¥", 72 => "Êó• - Nh·∫≠t", 
        73 => "Êõ∞ - Vi·∫øt", 74 => "Êúà - Nguy·ªát", 75 => "Êú® - M·ªôc", 76 => "Ê¨† - Khi·∫øm", 77 => "Ê≠¢ - Ch·ªâ", 78 => "Ê≠π - ƒê√£i", 
        79 => "ÊÆ≥ - Th√π", 80 => "ÊØã - V√¥", 81 => "ÊØî - T·ª∑", 82 => "ÊØõ - Mao", 83 => "Ê∞è - Th·ªã", 84 => "Ê∞î - Kh√≠", 
        85 => "Ê∞¥ - Th·ªßy", 86 => "ÁÅ´ - H·ªèa", 87 => "Áà™ - Tr·∫£o", 88 => "Áà∂ - Ph·ª•", 89 => "Áàª - H√†o", 90 => "Áàø - T∆∞·ªùng", 
        91 => "Áâá - Phi·∫øn", 92 => "Áâô - Nha", 93 => "Áâõ - Ng∆∞u", 94 => "Áä¨ - Khuy·ªÉn", 95 => "ÁéÑ - Huy·ªÅn", 96 => "Áéâ - Ng·ªçc", 
        97 => "Áìú - Qua", 98 => "Áì¶ - Ng√µa", 99 => "Áîò - Cam", 100 => "Áîü - Sinh", 101 => "Áî® - D·ª•ng", 102 => "Áî∞ - ƒêi·ªÅn", 
        103 => "Áñã - Th·∫•t", 104 => "Áñí - N·∫°ch", 105 => "Áô∂ - B√°t", 106 => "ÁôΩ - B·∫°ch", 107 => "ÁöÆ - B√¨", 108 => "Áöø - M√£nh", 
        109 => "ÁõÆ - M·ª•c", 110 => "Áüõ - M√¢u", 111 => "Áü¢ - Th·ªâ", 112 => "Áü≥ - Th·∫°ch", 113 => "Á§∫ - Th·ªã", 114 => "Á¶∏ - Nh·ª±u", 
        115 => "Á¶æ - H√≤a", 116 => "Á©¥ - Huy·ªát", 117 => "Á´ã - L·∫≠p", 118 => "Á´π - Tr√∫c", 119 => "Á±≥ - M·ªÖ", 
        120 => "Á≥∏ (Á∫ü) - M·ªãch", 
        121 => "Áº∂ - Ph·∫´u", 122 => "ÁΩë - V√µng", 123 => "Áæä - D∆∞∆°ng", 124 => "ÁæΩ - V≈©", 125 => "ËÄÅ - L√£o", 126 => "ËÄå - Nhi", 
        127 => "ËÄí - L·ªói", 128 => "ËÄ≥ - Nhƒ©", 129 => "ËÅø - Du·∫≠t", 130 => "ËÇâ - Nh·ª•c", 131 => "Ëá£ - Th·∫ßn", 132 => "Ëá™ - T·ª±", 
        133 => "Ëá≥ - Ch√≠", 134 => "Ëáº - C·ªØu", 135 => "Ëàå - Thi·ªát", 136 => "Ëàõ - Suy·ªÖn", 137 => "Ëàü - Ch√¢u", 138 => "ËâÆ - C·∫•n", 
        139 => "Ëâ≤ - S·∫Øc", 140 => "Ëâ∏ - Th·∫£o", 141 => "Ëôç - H·ªï", 142 => "Ëô´ - Tr√πng", 143 => "Ë°Ä - Huy·∫øt", 144 => "Ë°å - H√†nh", 
        145 => "Ë°£ - Y", 146 => "Ë•æ - √Å", 
        147 => "Ë¶ã (ËßÅ) - Ki·∫øn", 
        148 => "Ëßí - Gi√°c", 
        149 => "Ë®Ä (ËÆ†) - Ng√¥n", 
        150 => "Ë∞∑ - C·ªëc", 
        151 => "Ë±Ü - ƒê·∫≠u", 152 => "Ë±ï - Th·ªâ", 153 => "Ë±∏ - Tr√£i", 
        154 => "Ë≤ù (Ë¥ù) - B·ªëi", 
        155 => "Ëµ§ - X√≠ch", 156 => "Ëµ∞ - T·∫©u", 
        157 => "Ë∂≥ - T√∫c", 158 => "Ë∫´ - Th√¢n", 
        159 => "Ëªä (ËΩ¶) - Xa", 
        160 => "Ëæõ - T√¢n", 161 => "Ëæ∞ - Th·∫ßn", 
        162 => "Ëæµ (Ëæ∂) - S∆∞·ªõc", 
        163 => "ÈÇë - ·∫§p", 164 => "ÈÖâ - D·∫≠u", 165 => "ÈáÜ - Bi·ªán", 166 => "Èáå - L√Ω", 
        167 => "Èáë (ÈíÖ) - Kim", 
        168 => "Èï∑ (Èïø) - Tr∆∞·ªùng", 
        169 => "ÈñÄ (Èó®) - M√¥n", 
        170 => "Èòú - Ph·ª•", 171 => "Èö∂ - ƒê√£i", 172 => "Èöπ - Chuy", 173 => "Èõ® - V≈©", 
        174 => "Èùí - Thanh", 
        175 => "Èùû - Phi", 176 => "Èù¢ - Di·ªán", 177 => "Èù© - C√°ch", 
        178 => "Èüã (Èü¶) - Vi", 
        179 => "Èü≠ - C·ª≠u", 180 => "Èü≥ - √Çm", 
        181 => "È†Å (È°µ) - Hi·ªát", 
        182 => "È¢® (È£é) - Phong", 
        183 => "È£õ (È£û) - Phi", 
        184 => "È£ü (È•£) - Th·ª±c", 
        185 => "È¶ñ - Th·ªß", 186 => "È¶ô - H∆∞∆°ng", 
        187 => "È¶¨ (È©¨) - M√£", 
        188 => "È™® - C·ªët", 189 => "È´ò - Cao", 190 => "È´ü - B∆∞u", 
        191 => "È¨• (Êñó) - ƒê·∫•u", 
        192 => "È¨Ø - S∆∞·ªüng", 193 => "È¨≤ - C√°ch", 194 => "È¨º - Qu·ª∑", 
        195 => "È≠ö (È±º) - Ng∆∞", 
        196 => "È≥• (È∏ü) - ƒêi·ªÉu", 
        197 => "Èπµ - L·ªó", 
        198 => "Èπø - L·ªôc", 
        199 => "È∫• (È∫¶) - M·∫°ch", 
        200 => "È∫ª - Ma", 201 => "ÈªÉ - Ho√†ng", 202 => "Èªç - Th·ª≠", 203 => "Èªë - H·∫Øc", 204 => "Èªπ - Ch·ªâ", 
        205 => "ÈªΩ - M√£nh", 206 => "Èºé - ƒê·ªânh", 207 => "Èºì - C·ªï", 208 => "Èº† - Th·ª≠", 209 => "Èºª - T·ªã", 
        210 => "ÈΩä (ÈΩê) - T·ªÅ", 
        211 => "ÈΩí (ÈΩø) - X·ªâ", 
        212 => "Èæç (Èæô) - Long", 
        213 => "Èæú (Èæü) - Quy", 
        214 => "Èæ† - D∆∞·ª£c"
    ];

    // C·∫§U H√åNH NH√ìM N√âT
    $stroke_ranges = [
        1 => [1, 6], 2 => [7, 29], 3 => [30, 60], 4 => [61, 94], 
        5 => [95, 117], 6 => [118, 146], 7 => [147, 166], 8 => [167, 175],
        9 => [176, 186], 10 => [187, 194], 11 => [195, 200], 12 => [201, 204],
        13 => [205, 208], 14 => [209, 210], 15 => [211, 211], 16 => [212, 213], 17 => [214, 214]
    ];
    ?>
    
    <style>
        .hl-wrapper { max-width: 900px; margin: 0 auto; font-family: sans-serif; }
        
        /* Input & Sticky Bar */
        .hl-sticky-bar { 
            position: sticky; top: 10px; z-index: 100; 
            background: #fff; padding: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px;
            display: flex; gap: 10px; align-items: center; margin-bottom: 30px; border: 1px solid #ddd;
        }
        .hl-selected-info { font-weight: bold; color: #d32f2f; flex-grow: 1; font-size: 16px; }
        .hl-input-strokes { width: 150px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Nh√≥m n√©t */
        .hl-group-header { 
            display: flex; align-items: baseline; margin-top: 40px; margin-bottom: 15px; 
            border-bottom: 3px solid #eee; padding-bottom: 5px;
        }
        .hl-group-num { 
            font-size: 50px; font-weight: 900; color: #e0e0e0; 
            line-height: 0.8; margin-right: 10px; font-family: Arial, sans-serif;
            text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff; 
        }
        .hl-group-text { font-size: 14px; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 2px; }

        /* Grid b·ªô th·ªß */
        .hl-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        
        .hl-radical-item { 
            border: 1px solid #e0e0e0; background: #fff; border-radius: 6px; 
            padding: 8px 4px; text-align: center; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hl-radical-item:hover, .hl-radical-item.active { 
            border-color: #d32f2f; background: #fff5f5; transform: scale(1.05); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        
        .hl-rad-char { font-size: 24px; font-weight: bold; color: #333; line-height: 1.2; }
        .hl-rad-simp { font-size: 16px; color: #d32f2f; font-weight: bold; margin-bottom: 2px; } /* Style cho ch·ªØ gi·∫£n th·ªÉ */
        .hl-rad-name { font-size: 11px; color: #666; margin-top: 2px; }

        /* K·∫øt qu·∫£ */
        #hl-results-container { margin-top: 20px; }
        .hl-result-card { 
            display: inline-block; width: 60px; height: 60px; line-height: 60px; 
            text-align: center; border: 1px solid #eee; margin: 5px; border-radius: 4px;
            font-size: 28px; background: #fff; cursor: pointer;
        }
        .hl-result-card:hover { background: #333; color: white; }
    </style>

    <div class="hl-wrapper">
        <div class="hl-sticky-bar">
            <div class="hl-selected-info" id="hl-status">Vui l√≤ng ch·ªçn b·ªô th·ªß b√™n d∆∞·ªõi üëá</div>
            <input type="number" id="hl-strokes-input" class="hl-input-strokes" placeholder="S·ªë n√©t c√≤n l·∫°i" oninput="reFilterHanzi()">
        </div>

        <div id="hl-results-container" style="display:none; margin-bottom: 30px; border: 2px dashed #d32f2f; padding: 20px; border-radius: 8px; background: #fffaf0;">
            <h4 style="margin-top:0">K·∫øt qu·∫£ t√¨m ki·∫øm:</h4>
            <div id="hl-result-list"></div>
        </div>

        <div id="hl-radical-list">
            <?php 
            foreach ($stroke_ranges as $strokes => $range) {
                echo '<div class="hl-group-header">';
                echo '<span class="hl-group-num">' . $strokes . '</span>';
                echo '<span class="hl-group-text">N√âT</span>';
                echo '</div>';
                
                echo '<div class="hl-grid">';
                for ($id = $range[0]; $id <= $range[1]; $id++) {
                    if (isset($radicals[$id])) {
                        $raw = $radicals[$id]; // VD: "Ë®Ä (ËÆ†) - Ng√¥n" ho·∫∑c "‰∏Ä - Nh·∫•t"
                        
                        // T√°ch t√™n ra tr∆∞·ªõc (ph·∫ßn sau d·∫•u "-")
                        $parts = explode(' - ', $raw);
                        $chars_part = $parts[0]; // "Ë®Ä (ËÆ†)"
                        $name = isset($parts[1]) ? $parts[1] : '';

                        // Ki·ªÉm tra xem c√≥ gi·∫£n th·ªÉ trong ngo·∫∑c kh√¥ng
                        $main_char = $chars_part;
                        $simp_char = '';

                        if (strpos($chars_part, '(') !== false) {
                            // D√πng regex l·∫•y ch·ªØ trong ngo·∫∑c
                            if (preg_match('/^(.*) \((.*)\)$/', $chars_part, $matches)) {
                                $main_char = $matches[1]; // Ch·ªØ g·ªëc
                                $simp_char = $matches[2]; // Ch·ªØ gi·∫£n th·ªÉ
                            }
                        }

                        echo '<div class="hl-radical-item" onclick="selectRadical(this, '.$id.', \''. addslashes($raw) .'\')">';
                        
                        // Hi·ªÉn th·ªã ch·ªØ G·ªëc
                        echo '<div class="hl-rad-char">'.$main_char.'</div>';
                        
                        // Hi·ªÉn th·ªã ch·ªØ Gi·∫£n th·ªÉ (n·∫øu c√≥)
                        if ($simp_char) {
                            echo '<div class="hl-rad-simp">('.$simp_char.')</div>';
                        }
                        
                        echo '<div class="hl-rad-name">'.$name.'</div>';
                        echo '</div>';
                    }
                }
                echo '</div>';
            }
            ?>
        </div>
        <p id="hl-loading" style="display:none; text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <script>
    let hanziDb = [];
    let currentRadicalId = null;

    // ============================================
    // C·∫§U H√åNH ƒê∆Ø·ªúNG D·∫™N WEB C·ª¶A B·∫†N
    // ============================================
    const urlPattern = '/?s='; 
    // const urlPattern = '/tu-dien/';
    // ============================================

    window.addEventListener('load', function(){
        fetch('/wp-content/uploads/hantu_data.json')
            .then(r => r.json())
            .then(data => { hanziDb = data; })
            .catch(e => console.error("L·ªói t·∫£i JSON:", e));
    });

    function selectRadical(el, id, rawName) {
        document.querySelectorAll('.hl-radical-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        currentRadicalId = id;
        
        // L√†m s·∫°ch chu·ªói rawName ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp tr√™n thanh status
        document.getElementById('hl-status').innerText = `ƒêang tra: B·ªô ${id} [${rawName}]`;
        reFilterHanzi();
    }

    function reFilterHanzi() {
        if (!currentRadicalId || hanziDb.length === 0) return;

        const remainStrokesStr = document.getElementById('hl-strokes-input').value;
        const resultContainer = document.getElementById('hl-results-container');
        const resultList = document.getElementById('hl-result-list');

        resultList.innerHTML = 'ƒêang l·ªçc...';
        resultContainer.style.display = 'block';

        const results = hanziDb.filter(item => {
            const matchRad = item.radical === currentRadicalId;
            const matchStr = remainStrokesStr === "" ? true : item.remain_strokes === parseInt(remainStrokesStr);
            return matchRad && matchStr;
        });

        resultList.innerHTML = '';
        if (results.length === 0) {
            resultList.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y ch·ªØ n√†o.</p>';
            return;
        }

        results.forEach(item => {
            const div = document.createElement('div');
            div.className = 'hl-result-card';
            div.innerText = item.char;
            div.title = `Tra c·ª©u ch·ªØ: ${item.char}`;
            div.onclick = () => {
                const finalUrl = urlPattern + item.char;
                window.open(finalUrl, '_blank');
            };
            resultList.appendChild(div);
        });
    }
    </script>
    <?php
    return ob_get_clean();
}
